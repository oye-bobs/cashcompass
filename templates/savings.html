{% extends "layout.html" %}

{% block title %}
    Savings
{% endblock %}

{% block main %}
    <div class="row"> {# Changed from container py-8 to row for consistent layout #}
        <!-- Left Half: Add Savings Form -->
        <div class="col-md-6">
            <div class="card shadow-sm"> {# Removed border-0 h-100 for consistent card styling #}
                <div class="card-header bg-primary text-white"> {# Matched budget/expenses.html card-header style #}
                    <h5 class="card-title mb-0">Add New Savings Item</h5> {# Matched budget/expenses.html h5 and mb-0 #}
                </div>
                <div class="card-body"> {# Removed p-4 p-md-5 for consistent card-body padding #}
                    <form action="/savings" method="post" autocomplete="off">
                        <div class="mb-3">
                            <label for="goal" class="form-label">Savings Goal</label> {# Removed text-muted #}
                            <input
                                id="goal"
                                name="goal"
                                type="text"
                                class="form-control"
                                placeholder="e.g., Emergency Fund, New Car, House Down Payment"
                                required
                                autocomplete="off"
                            >
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">Current Amount Saved</label> {# Changed label #}
                            <div class="input-group"> {# Added input-group for currency symbol #}
                                <span class="input-group-text">$</span> {# Changed to $ for consistency #}
                                <input
                                    id="amount"
                                    name="amount"
                                    type="number"
                                    min="0" {# Changed min to 0 as current amount can be 0 #}
                                    step="0.01"
                                    class="form-control"
                                    placeholder="Enter current amount saved" {# Updated placeholder #}
                                    required
                                    autocomplete="off"
                                >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="target-amount" class="form-label">Target Amount</label> {# New field for target amount #}
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input
                                    id="target-amount"
                                    name="target_amount" {# Name for Flask form data #}
                                    type="number"
                                    min="1" {# Target amount should be at least 1 #}
                                    step="0.01"
                                    class="form-control"
                                    placeholder="Enter target amount (e.g., 10000)"
                                    required
                                    autocomplete="off"
                                >
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-100"> {# Changed to btn-success w-100 #}
                            <i class="fas fa-plus-circle"></i> Add Savings Goal
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Half: Savings Overview Table -->
        <div class="col-md-6">
            <div class="card shadow-sm"> {# Removed border-0 h-100 for consistent card styling #}
                <div class="card-header bg-primary text-white"> {# Matched budget/expenses.html card-header style #}
                    <h5 class="card-title mb-0">Current Savings Overview</h5> {# No dynamic month needed here #}
                </div>
                <div class="card-body"> {# Removed p-4 p-md-5 for consistent card-body padding #}
                    {# Removed month selection dropdown for Savings #}

                    {% if savings_items %}
                        <div class="table-responsive">
                            <table class="table table-hover"> {# Changed from table-striped table-hover to table-hover #}
                                <thead>
                                    <tr>
                                        <th scope="col">Goal</th>
                                        <th scope="col" class="text-end">Current ($)</th> {# Changed column header #}
                                        <th scope="col" class="text-end">Target ($)</th> {# New column header #}
                                        <th scope="col" class="text-end">Actions</th> {# Added Actions column #}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in savings_items %}
                                        <tr>
                                            <td>{{ item.goal }}</td>
                                            <td class="text-end">${{ "%.2f" | format(item.amount) }}</td> {# Current Amount #}
                                            <td class="text-end">${{ "%.2f" | format(item.target_amount) }}</td> {# Target Amount #}
                                            <td class="text-end">
                                                <!-- Edit Button (Triggers Modal) -->
                                                <button class="btn btn-sm btn-outline-primary edit-savings-btn"
                                                        data-bs-toggle="modal" data-bs-target="#editSavingsModal"
                                                        data-id="{{ item.id }}"
                                                        data-goal="{{ item.goal }}"
                                                        data-amount="{{ item.amount }}"
                                                        data-target-amount="{{ item.target_amount }}" {# Pass target amount #}
                                                        title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <!-- Delete Button (Triggers Confirmation) -->
                                                <button class="btn btn-sm btn-outline-danger delete-savings-btn"
                                                        data-id="{{ item.id }}"
                                                        data-goal="{{ item.goal }}"
                                                        title="Delete"
                                                        data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light"> {# Changed from table-primary to table-light for consistency #}
                                    <tr class="fw-bold">
                                        <td>Total Current Savings:</td> {# Changed label #}
                                        <td class="text-end">${{ "%.2f" | format(total_current_savings) }}</td> {# Now only current savings #}
                                        <td></td> {# Empty cell for Target ($) column #}
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted fs-5 py-4">No savings goals added yet. Use the form on the left to add your first savings goal!</p> {# Updated text #}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

<!-- Edit Savings Modal -->
<div class="modal fade" id="editSavingsModal" tabindex="-1" aria-labelledby="editSavingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editSavingsModalLabel">Edit Savings Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editSavingsForm" method="post">
                <div class="modal-body">
                    <input type="hidden" id="editSavingsId" name="id">
                    <div class="mb-3">
                        <label for="editGoal" class="form-label">Savings Goal</label>
                        <input type="text" class="form-control" id="editGoal" name="goal" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAmount" class="form-label">Current Amount Saved</label> {# Changed label #}
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="editAmount" name="amount" step="0.01" min="0" required> {# Changed min to 0 #}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editTargetAmount" class="form-label">Target Amount</label> {# New field #}
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="editTargetAmount" name="target_amount" step="0.01" min="1" required> {# New field #}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the savings item for "<span id="deleteGoalSpan"></span>"? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteSavingsForm" method="post" style="display:inline;">
                    <input type="hidden" id="deleteSavingsId" name="id">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Edit Savings Button Click to populate modal
        const editSavingsModal = document.getElementById('editSavingsModal');
        if (editSavingsModal) {
            editSavingsModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const goal = button.getAttribute('data-goal');
                const amount = button.getAttribute('data-amount');
                const targetAmount = button.getAttribute('data-target-amount'); // Get target amount

                // Update the modal's content
                const modalTitle = editSavingsModal.querySelector('.modal-title');
                const editSavingsId = editSavingsModal.querySelector('#editSavingsId');
                const editGoalInput = editSavingsModal.querySelector('#editGoal');
                const editAmountInput = editSavingsModal.querySelector('#editAmount');
                const editTargetAmountInput = editSavingsModal.querySelector('#editTargetAmount'); // New input
                const editSavingsForm = editSavingsModal.querySelector('#editSavingsForm');

                modalTitle.textContent = 'Edit Savings Item: ' + goal;
                editSavingsId.value = id;
                editGoalInput.value = goal;
                editAmountInput.value = parseFloat(amount).toFixed(2);
                editTargetAmountInput.value = parseFloat(targetAmount).toFixed(2); // Set target amount

                // Set the form action dynamically
                editSavingsForm.action = `/savings/edit/${id}`;
            });
        }

        // Handle Delete Savings Button Click to populate confirmation modal
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        if (deleteConfirmationModal) {
            deleteConfirmationModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const goal = button.getAttribute('data-goal');

                // Update the modal's content
                const deleteGoalSpan = deleteConfirmationModal.querySelector('#deleteGoalSpan');
                const deleteSavingsId = deleteConfirmationModal.querySelector('#deleteSavingsId');
                const deleteSavingsForm = deleteConfirmationModal.querySelector('#deleteSavingsForm');

                deleteGoalSpan.textContent = goal;
                deleteSavingsId.value = id;

                // Set the form action dynamically
                deleteSavingsForm.action = `/savings/delete/${id}`;
            });
        }
    });
</script>
{% endblock %}

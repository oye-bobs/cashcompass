{% extends "layout.html" %}

{% block title %}
    Expenses
{% endblock %}

{% block main %}
    <div class="row"> {# Changed from container py-8 to row #}
        <!-- Left Half: Add Expense Form -->
        <div class="col-md-6">
            <div class="card shadow-sm"> {# Removed border-0 h-100 #}
                <div class="card-header bg-primary text-white"> {# Matched budget.html card-header #}
                    <h5 class="card-title mb-0">Add New Expense Item</h5> {# Matched budget.html h5 and mb-0 #}
                </div>
                <div class="card-body"> {# Removed p-4 p-md-5 #}
                    <form action="/expenses" method="post" autocomplete="off">
                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label> {# Removed text-muted #}
                            <select id="category" name="category" class="form-select" required>
                                <option disabled selected value="">-- Select a Category --</option>
                                {# Assuming 'categories' list is passed from Flask #}
                                {% for category in categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount</label> {# Removed (₦) and text-muted #}
                            <div class="input-group"> {# Added input-group #}
                                <span class="input-group-text">$</span> {# Changed to $ #}
                                <input id="amount" name="amount" type="number" min="1" step="0.01" class="form-control" placeholder="Enter amount (e.g., 500)" required> {# Changed placeholder #}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="expense-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="expense-date" name="date" value="{{ current_date_iso }}" required>
                        </div>
                        <button class="btn btn-success w-100" type="submit"> {# Changed from btn-primary btn-lg d-grid to btn-success w-100 #}
                            <i class="fas fa-plus-circle"></i> Add Expense
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Half: Expenses Overview Table -->
        <div class="col-md-6">
            <div class="card shadow-sm"> {# Removed border-0 h-100 #}
                <div class="card-header bg-primary text-white"> {# Matched budget.html card-header #}
                    <h5 class="card-title mb-0">Expenses Overview for {{ selected_month_display }}</h5> {# Dynamic title #}
                </div>
                <div class="card-body"> {# Removed p-4 p-md-5 #}
                    <div class="d-flex justify-content-end mb-3">
                        <form action="/expenses" method="get" class="d-flex">
                            <label for="view-month-select" class="form-label me-2 my-auto">View Month:</label>
                            <select name="month" id="view-month-select" class="form-select me-2" onchange="this.form.submit()">
                                {% for month_val, month_label in available_months %}
                                    <option value="{{ month_val }}" {% if month_val == selected_month %}selected{% endif %}>
                                        {{ month_label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    {# Assuming 'expenses_items' list is passed from Flask #}
                    {% if expenses_items %}
                        <div class="table-responsive">
                            <table class="table table-hover"> {# Changed from table-striped table-hover to table-hover #}
                                <thead>
                                    <tr>
                                        <th scope="col">Category</th>
                                        <th scope="col" class="text-end">Amount ($)</th> {# Changed to $ #}
                                        {# Removed Date column header #}
                                        <th scope="col" class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in expenses_items %}
                                        <tr>
                                            <td>{{ item.category }}</td>
                                            <td class="text-end">${{ "%.2f" | format(item.amount) }}</td> {# Changed to $ #}
                                            {# Removed Date column data #}
                                            <td class="text-end">
                                                <!-- Edit Button (Triggers Modal) -->
                                                <button class="btn btn-sm btn-outline-primary edit-expense-btn"
                                                        data-bs-toggle="modal" data-bs-target="#editExpenseModal"
                                                        data-id="{{ item.id }}"
                                                        data-category="{{ item.category }}"
                                                        data-amount="{{ item.amount }}"
                                                        data-date="{{ item.date | default('') }}" {# Pass date to modal #}
                                                        title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <!-- Delete Button (Triggers Confirmation) -->
                                                <button class="btn btn-sm btn-outline-danger delete-expense-btn"
                                                        data-id="{{ item.id }}"
                                                        data-category="{{ item.category }}"
                                                        title="Delete"
                                                        data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light"> {# Changed from table-primary to table-light #}
                                    <tr class="fw-bold">
                                        <td>Total Expenses for {{ selected_month_display }}:</td> {# Dynamic total #}
                                        <td class="text-end">${{ "%.2f" | format(total_expenses) }}</td> {# Changed to $ #}
                                        {# Adjusted colspan by removing one empty <td> #}
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No expenses added for {{ selected_month_display }} yet. Use the form on the left to add your first expense!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

<!-- Edit Expense Modal -->
<div class="modal fade" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editExpenseModalLabel">Edit Expense Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editExpenseForm" method="post">
                <div class="modal-body">
                    <input type="hidden" id="editExpenseId" name="id">
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">Category</label>
                        <input type="text" class="form-control" id="editCategory" name="category" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAmount" class="form-label">Amount</label> {# Removed (₦) #}
                        <div class="input-group">
                            <span class="input-group-text">$</span> {# Changed to $ #}
                            <input type="number" class="form-control" id="editAmount" name="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editExpenseDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editExpenseDate" name="date" required> {# New date input #}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the expense item for "<span id="deleteCategorySpan"></span>"? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteExpenseForm" method="post" style="display:inline;">
                    <input type="hidden" id="deleteExpenseId" name="id">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Edit Button Click to populate modal
        const editExpenseModal = document.getElementById('editExpenseModal');
        if (editExpenseModal) { // Check if the modal exists before adding listener
            editExpenseModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // Button that triggered the modal
                const id = button.getAttribute('data-id');
                const category = button.getAttribute('data-category');
                const amount = button.getAttribute('data-amount');
                const date = button.getAttribute('data-date'); // Get the date

                // Update the modal's content
                const modalTitle = editExpenseModal.querySelector('.modal-title');
                const editExpenseId = editExpenseModal.querySelector('#editExpenseId');
                const editCategoryInput = editExpenseModal.querySelector('#editCategory');
                const editAmountInput = editExpenseModal.querySelector('#editAmount');
                const editExpenseDateInput = editExpenseModal.querySelector('#editExpenseDate'); // Get date input
                const editExpenseForm = editExpenseModal.querySelector('#editExpenseForm');

                modalTitle.textContent = 'Edit Expense Item: ' + category;
                editExpenseId.value = id;
                editCategoryInput.value = category;
                editAmountInput.value = parseFloat(amount).toFixed(2); // Ensure two decimal places

                // Format date for input[type="date"]
                if (date) {
                    // Ensure date is in YYYY-MM-DD format for the input[type="date"]
                    editExpenseDateInput.value = new Date(date).toISOString().split('T')[0];
                } else {
                    editExpenseDateInput.value = ''; // Clear if no date
                }

                // Set the form action dynamically
                editExpenseForm.action = `/expenses/edit/${id}`; // Assuming Flask route like /expenses/edit/<id>
            });
        }


        // Handle Delete Button Click to populate confirmation modal
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        if (deleteConfirmationModal) { // Check if the modal exists before adding listener
            deleteConfirmationModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // Button that triggered the modal
                const id = button.getAttribute('data-id');
                const category = button.getAttribute('data-category');

                // Update the modal's content
                const deleteCategorySpan = deleteConfirmationModal.querySelector('#deleteCategorySpan');
                const deleteExpenseId = deleteConfirmationModal.querySelector('#deleteExpenseId');
                const deleteExpenseForm = deleteConfirmationModal.querySelector('#deleteExpenseForm');

                deleteCategorySpan.textContent = category;
                deleteExpenseId.value = id;

                // Set the form action dynamically
                deleteExpenseForm.action = `/expenses/delete/${id}`; // Assuming Flask route like /expenses/delete/<id>
            });
        }

        // Add event listener for delete buttons to open the modal
        // This is handled by data-bs-toggle="modal" directly on the button.
        // No explicit JS needed here for just opening the modal.
    });
</script>
{% endblock %}

{% extends "layout.html" %}

{% block title %}Create Budget{% endblock %}

{% block main %}
<div class="row">
    <!-- Left Column - Add New Budget -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Add New Budget Item</h5>
            </div>
            <div class="card-body">
                <form action="/budget" method="post">
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <input type="text" class="form-control" id="category" name="category"
                               placeholder="e.g., Groceries, Rent" required>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="amount" name="amount"
                                   placeholder="Enter amount (e.g., 500)" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="budget-month" class="form-label">Budget for Month</label>
                        <input type="month" class="form-control" id="budget-month" name="month"
                               value="{{ current_month_iso }}" required> {# Set default to current month #}
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-plus-circle"></i> Add Budget
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Column - Current Budget Overview -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Budget Overview for {{ selected_month_display }}</h5> {# Dynamic title #}
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-end mb-3">
                    <form action="/budget" method="get" class="d-flex">
                        <label for="view-month-select" class="form-label me-2 my-auto">View Month:</label>
                        <select name="month" id="view-month-select" class="form-select me-2" onchange="this.form.submit()">
                            {% for month_val, month_label in available_months %}
                                <option value="{{ month_val }}" {% if month_val == selected_month %}selected{% endif %}>
                                    {{ month_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>

                {% if budget_items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Amount ($)</th>
                                    <th class="text-end">Date</th> {# Display the date #}
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in budget_items %}
                                <tr>
                                    <td>{{ item.category }}</td>
                                    <td class="text-end">${{ "%.2f" | format(item.amount) }}</td>
                                    {# Corrected date format to MM/YYYY using a more robust approach #}
                                    <td class="text-end">
                                        {% if item.date %}
                                            {# Convert date to datetime object first, then format #}
                                            {{ item.date | to_datetime | default(item.date, true) | date_format('%m/%Y') }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <!-- Edit Button (Triggers Modal) -->
                                        <button class="btn btn-sm btn-outline-primary edit-budget-btn"
                                                data-bs-toggle="modal" data-bs-target="#editBudgetModal"
                                                data-id="{{ item.id }}"
                                                data-category="{{ item.category }}"
                                                data-amount="{{ item.amount }}"
                                                data-date="{{ item.date | default('') }}" {# Pass date to modal #}
                                                title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <!-- Delete Button (Triggers Confirmation) -->
                                        <button class="btn btn-sm btn-outline-danger delete-budget-btn"
                                                data-id="{{ item.id }}"
                                                data-category="{{ item.category }}"
                                                title="Delete"
                                                data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr class="fw-bold">
                                    <td>Total Budget for {{ selected_month_display }}:</td> {# Dynamic total #}
                                    <td class="text-end">${{ "%.2f" | format(total_budget) }}</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <p class="text-center text-muted">No budget items added for {{ selected_month_display }} yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Budget Modal -->
<div class="modal fade" id="editBudgetModal" tabindex="-1" aria-labelledby="editBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editBudgetModalLabel">Edit Budget Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editBudgetForm" method="post">
                <div class="modal-body">
                    <input type="hidden" id="editBudgetId" name="id">
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">Category</label>
                        <input type="text" class="form-control" id="editCategory" name="category" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAmount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="editAmount" name="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editBudgetDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editBudgetDate" name="date" required> {# Date field #}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the budget item for "<span id="deleteCategorySpan"></span>"? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteBudgetForm" method="post" style="display:inline;">
                    <input type="hidden" id="deleteBudgetId" name="id">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Edit Button Click to populate modal
        const editBudgetModal = document.getElementById('editBudgetModal');
        editBudgetModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal
            const id = button.getAttribute('data-id');
            const category = button.getAttribute('data-category');
            const amount = button.getAttribute('data-amount');
            const date = button.getAttribute('data-date'); // Get the date

            // Update the modal's content
            const modalTitle = editBudgetModal.querySelector('.modal-title');
            const editBudgetId = editBudgetModal.querySelector('#editBudgetId');
            const editCategoryInput = editBudgetModal.querySelector('#editCategory');
            const editAmountInput = editBudgetModal.querySelector('#editAmount');
            const editBudgetDateInput = editBudgetModal.querySelector('#editBudgetDate'); // Get date input
            const editBudgetForm = editBudgetModal.querySelector('#editBudgetForm');

            modalTitle.textContent = 'Edit Budget Item: ' + category;
            editBudgetId.value = id;
            editCategoryInput.value = category;
            editAmountInput.value = parseFloat(amount).toFixed(2); // Ensure two decimal places

            // Format date for input[type="date"]
            if (date) {
                // Ensure date is in YYYY-MM-DD format for the input[type="date"]
                editBudgetDateInput.value = new Date(date).toISOString().split('T')[0];
            } else {
                editBudgetDateInput.value = ''; // Clear if no date
            }

            // Set the form action dynamically
            editBudgetForm.action = `/budget/edit/${id}`; // Assuming Flask route like /budget/edit/<id>
        });

        // Handle Delete Button Click to populate confirmation modal
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        deleteConfirmationModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal
            const id = button.getAttribute('data-id');
            const category = button.getAttribute('data-category');

            // Update the modal's content
            const deleteCategorySpan = deleteConfirmationModal.querySelector('#deleteCategorySpan');
            const deleteBudgetId = deleteConfirmationModal.querySelector('#deleteBudgetId');
            const deleteBudgetForm = deleteConfirmationModal.querySelector('#deleteBudgetForm');

            deleteCategorySpan.textContent = category;
            deleteBudgetId.value = id;

            // Set the form action dynamically
            deleteBudgetForm.action = `/budget/delete/${id}`; // Assuming Flask route like /budget/delete/<id>
        });
    });
</script>
{% endblock %}

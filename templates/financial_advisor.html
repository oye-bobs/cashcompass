{% extends "layout.html" %}

{% block title %}
    Financial Advisor
{% endblock %}

{% block main %}
<div class="container py-4">
    <h2 class="text-3xl font-bold text-center text-dark mb-4">Your AI Financial Advisor</h2>

    <div class="card shadow-sm rounded-lg mb-4">
        <div class="card-header bg-primary text-white rounded-t-lg">
            <h5 class="card-title mb-0">Personalized Financial Advice</h5>
        </div>
        <div class="card-body">
            <div id="adviceContent">
                <div class="text-center text-muted fs-5 py-4">
                    <p>Click "Get Advice" to receive personalized financial guidance.</p>
                </div>
            </div>

            <div id="loadingIndicator" class="text-center py-4 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Generating advice, please wait...</p>
            </div>

            <div id="errorDisplay" class="alert alert-danger d-none" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage"></span>
            </div>

            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary btn-lg" id="getAdviceButton">
                    <i class="fas fa-magic me-2"></i> Get Advice
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> {# NEW: Marked.js for Markdown parsing #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded fired.");

        // Check if JSON object is defined globally - This error is highly unusual for modern browsers.
        if (typeof JSON === 'undefined') {
            console.error("ERROR: The global JSON object is not defined. This is highly unusual for a modern browser environment.");
            // Display a user-facing error if JSON is not available
            errorMessageSpan.textContent = "Your browser environment does not support core JavaScript features. Please update your browser.";
            errorDisplay.classList.remove('d-none');
            getAdviceButton.disabled = true;
            return; // Stop script execution if JSON is not defined
        }

        const getAdviceButton = document.getElementById('getAdviceButton');
        const adviceContent = document.getElementById('adviceContent');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const errorMessageSpan = document.getElementById('errorMessage');

        let financialData = {};
        const rawFinancialData = '{{ financial_data | safe }}';

        console.log("Raw financial data from Flask:", rawFinancialData);
        console.log("Type of raw financial data:", typeof rawFinancialData);

        try {
            // Attempt to parse only if the string is not empty, otherwise default to an an empty object
            if (rawFinancialData && rawFinancialData.trim() !== '') {
                financialData = JSON.parse(rawFinancialData);
            } else {
                console.warn("Raw financial data is empty or whitespace. Initializing financialData as an empty object.");
            }
        } catch (e) {
            console.error("Error parsing financial data from Flask:", e);
            errorMessageSpan.textContent = `Error loading financial data: ${e.message}. Please ensure your data is valid.`;
            errorDisplay.classList.remove('d-none');
            getAdviceButton.disabled = true; // Disable button if essential data is unparsable
            return; // Stop further execution if essential data is unparsable
        }
        console.log("Parsed financial data:", financialData);

        async function getFinancialAdvice() {
            adviceContent.innerHTML = ''; // Clear previous advice
            errorDisplay.classList.add('d-none'); // Hide any previous errors
            loadingIndicator.classList.remove('d-none'); // Show loading indicator
            getAdviceButton.disabled = true; // Disable button during loading

            // Construct the prompt using the parsed financialData
            const prompt = `
            Based on the following financial data, provide comprehensive, actionable, and encouraging financial advice.
            Identify key strengths and areas for improvement.
            Format your response using clear headings and bullet points where appropriate.
            Also ensure not to suggest any competitors or alternatives to our services.

            Financial Summary:
            - Total Income (All Time): $${financialData.total_income_all_time !== undefined ? financialData.total_income_all_time.toFixed(2) : 'N/A'}
            - Total Expenses (All Time): $${financialData.total_expenses_all_time !== undefined ? financialData.total_expenses_all_time.toFixed(2) : 'N/A'}
            - Current Net Worth (Simplified Assets - Liabilities): $${financialData.net_worth !== undefined ? financialData.net_worth.toFixed(2) : 'N/A'}
            - Overall Cash Flow (All Time Income - Expenses): $${financialData.cash_flow !== undefined ? financialData.cash_flow.toFixed(2) : 'N/A'}
            - Total Current Savings: $${financialData.total_savings !== undefined ? financialData.total_savings.toFixed(2) : 'N/A'}
            - Total Current Debt: $${financialData.total_debt !== undefined ? financialData.total_debt.toFixed(2) : 'N/A'}
            - Average Monthly Expenses: $${financialData.average_monthly_expenses !== undefined ? financialData.average_monthly_expenses.toFixed(2) : 'N/A'}

            Detailed Insights:
            - Emergency Fund Target (3 months expenses): $${financialData.emergency_fund_target_3_months !== undefined ? financialData.emergency_fund_target_3_months.toFixed(2) : 'N/A'}
            - Emergency Fund Coverage: ${financialData.emergency_fund_coverage !== undefined ? financialData.emergency_fund_coverage.toFixed(1) : 'N/A'} months
            - Budget Adherence (Current Month Over Budget): ${financialData.over_budget_categories && financialData.over_budget_categories.length > 0 ? financialData.over_budget_categories.join(', ') : 'None'}
            - Top 3 Spending Categories (Overall): ${financialData.top_spending_categories_str !== undefined ? financialData.top_spending_categories_str : 'N/A'}

            Please provide advice on:
            1. Overall financial health assessment.
            2. Recommendations for improving net worth and cash flow.
            3. Strategies for debt management.
            4. Tips for building a stronger emergency fund.
            5. Guidance on budgeting and spending habits.
            6. Any other relevant insights or warnings.
            `;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };

            // *** IMPORTANT: Replace 'YOUR_GEMINI_API_KEY_HERE' with your actual API Key ***
            // You can get an API Key from Google AI Studio: https://aistudio.google.com/app/apikey
            const apiKey = 'AIzaSyDxSc2fYnk7rD4Uah2d0i-JsnEHvqUOcAw';

            // --- NEW CHECK FOR API KEY ---
            if (!apiKey || apiKey === 'YOUR_GEMINI_API_KEY_HERE') {
                errorMessageSpan.textContent = `API Key is missing or not configured. Please get an API key from Google AI Studio and replace 'YOUR_GEMINI_API_KEY_HERE' in financial_advisor.html.`;
                errorDisplay.classList.remove('d-none');
                loadingIndicator.classList.add('d-none');
                getAdviceButton.disabled = false;
                console.error("API Key is undefined, empty, or still the placeholder.");
                return; // Stop execution if no API key
            }
            // --- END NEW CHECK ---

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    // NEW: Use marked.parse to convert Markdown to HTML
                    adviceContent.innerHTML = `<div class="financial-advice-output" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; color: #343a40;">${marked.parse(text)}</div>`;
                } else {
                    adviceContent.innerHTML = `<div class="alert alert-warning" role="alert">No advice generated. The AI response was empty or malformed.</div>`;
                    console.error("Gemini API returned unexpected structure:", result);
                }

            } catch (error) {
                errorMessageSpan.textContent = `Failed to get advice: ${error.message}. Please try again.`;
                errorDisplay.classList.remove('d-none');
                console.error("Error calling Gemini API:", error);
            } finally {
                loadingIndicator.classList.add('d-none'); // Hide loading indicator
                getAdviceButton.disabled = false; // Re-enable button
            }
        }

        getAdviceButton.addEventListener('click', getFinancialAdvice);

        // Optional: Generate advice automatically on page load if desired
        // getFinancialAdvice();
    });
</script>
{% endblock %}
